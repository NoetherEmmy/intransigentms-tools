/* Author: Emmy Noether of IntransigentMS (intransigentms.com) */
var Dialogue=function(){var a=function(a,b){return function(){var c=a,d=b,e=a,f=[],g="",h=function(a){function b(){return d.callback&&d.callback(),d.nodispose||cm.dispose(),g}function h(a,b){for(var c=[a];c.length>0;){var d=c.pop();if(d.id===b)return d;if(d.choices)for(var e=0;e<d.choices.length;++e)Array.isArray(d.choices[e])&&c.push(d.choices[e][1])}}var i;if(void 0!==a){if(a==-1)if("continue"==d.endchat)a=0;else if("back"==d.endchat)a=-3;else{if("stay"!=d.endchat)return b();a=-1}if(0===f.length&&a<-1)return b();if(a>=0){if(!e.choices[a])return b();e=e.choices[a][1],f.push(a)}else if(a!=-1){for(i=-2;i>a;--i)if(void 0===f.pop())return b();for(e=c,i=0;i<f.length;++i)e=e.choices[f[i]][1]}if(void 0!==e.goto){var j=e.goto;if(e=h(c,j),!e)throw ReferenceError("There exists no such node with the id "+j)}}if(!e||!e.prompt)return b();if(g=e.prompt,!e.choices)return cm.sendOk(g),b();var k=g+"\r\n\r\n",l=e.choices;for(i=0;i<l.length;++i){var m=l[i];k+=void 0!==m[1].move?"#L"+(m[1].move>0?i:0==m[1].move?-1:m[1].move-2)+"#"+m[0]+"#l\r\n":"#L"+i+"#"+(Array.isArray(m)?m[0]:m)+"#l\r\n"}cm.sendSimple(k)},i=function(a){d.callback=a},j=function(a){d.endchat=a},k=function(a){d.nodispose=a},l=function(){c=d=e=f=g=void 0,delete this.setCallback,delete this.setEndChat,delete this.setNoDispose,delete this.talk,delete this.unload};return{talk:h,setCallback:i,setEndChat:j,setNoDispose:k,unload:l}}()};return{load:a}}();